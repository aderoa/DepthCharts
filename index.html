<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBA Depth Charts by Trade Value</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    header { text-align: center; margin-bottom: 2rem; }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .subtitle { color: #8892b0; font-size: 1.1rem; }
    .back-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; text-decoration: none; font-weight: 500; margin-bottom: 1.5rem; transition: all 0.2s; }
    .back-btn:hover { background: rgba(255,255,255,0.2); }

    /* Admin banner */
    .admin-banner { display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; text-align: center; padding: 0.5rem 1rem; font-weight: 700; font-size: 0.9rem; position: sticky; top: 0; z-index: 100; }
    .admin-banner.active { display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .admin-save-status { display: inline-block; font-weight: 500; opacity: 0; transition: opacity 0.3s; }
    .admin-save-status.visible { opacity: 1; }
    .export-btn { padding: 0.4rem 1rem; background: #1a1a2e; color: #f59e0b; border: 1px solid #1a1a2e; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
    .export-btn:hover { background: #2a2a4e; }

    /* Team grid */
    .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
    .team-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 1.25rem; text-align: center; cursor: pointer; transition: all 0.2s; text-decoration: none; color: white; }
    .team-card:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); transform: translateY(-2px); }
    .team-logo { width: 56px; height: 56px; margin: 0 auto 0.75rem; object-fit: contain; }
    .team-name { font-weight: 600; font-size: 0.95rem; }
    .team-abbrev { color: #8892b0; font-size: 0.8rem; margin-top: 0.25rem; }

    /* Single team view */
    .depth-chart-container { display: none; }
    .depth-chart-container.active { display: block; }
    .team-header { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    .team-header-logo { width: 72px; height: 72px; object-fit: contain; }
    .team-header-name { font-size: 1.75rem; font-weight: 700; }
    .drag-hint { text-align: center; color: #8892b0; font-size: 0.85rem; margin-bottom: 1rem; }

    .depth-chart { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; background: rgba(255,255,255,0.95); border-radius: 16px; padding: 1.25rem; color: #1a1a2e; }
    .position-column { display: flex; flex-direction: column; gap: 0.5rem; min-height: 200px; }
    .position-header { text-align: center; font-weight: 700; font-size: 1.1rem; color: #1a1a2e; padding: 0.5rem; border-bottom: 3px solid #667eea; margin-bottom: 0.25rem; }
    .player-card { background: white; border-radius: 12px; padding: 0.75rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s; border: 2px solid transparent; cursor: grab; user-select: none; }
    .player-card.spacer { background: transparent; box-shadow: none; border: 1px dashed #333; opacity: 0.3; cursor: default; }
    .player-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); border-color: #667eea; }
    .player-card.starter { background: linear-gradient(135deg, #fff 0%, #f0f4ff 100%); border: 2px solid #667eea; }
    .player-card.dragging { opacity: 0.5; cursor: grabbing; }
    .player-card.drag-over { border: 2px dashed #667eea; background: #f0f4ff; }
    .position-column.drag-over { background: rgba(102,126,234,0.1); border-radius: 8px; }
    .player-image { width: 80px; height: 60px; margin: 0 auto 0.5rem; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; overflow: hidden; pointer-events: none; }
    .player-image img { width: 100%; height: 100%; object-fit: cover; }
    .player-image .initials { color: white; font-weight: 700; font-size: 1.2rem; }
    .player-name { font-weight: 600; font-size: 0.8rem; color: #1a1a2e; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
    .trade-value { font-size: 0.8rem; font-weight: 600; pointer-events: none; }
    .trade-value.high { color: #16a34a; }
    .trade-value.medium { color: #ca8a04; }
    .trade-value.low { color: #6b7280; }

    .loading { text-align: center; padding: 4rem 2rem; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { text-align: center; padding: 2rem; color: #f87171; }
    footer { text-align: center; margin-top: 2rem; padding: 1rem; color: #8892b0; font-size: 0.9rem; }
    footer a { color: #667eea; text-decoration: none; }

    /* Admin all-teams */
    .admin-all-teams { display: none; }
    .admin-all-teams.active { display: block; }
    .admin-team-row { margin-bottom: 1.5rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; overflow: hidden; }
    .admin-team-row-header { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .admin-team-row-logo { width: 36px; height: 36px; object-fit: contain; }
    .admin-team-row-name { font-weight: 700; font-size: 1rem; }
    .admin-team-row-abbrev { color: #8892b0; font-size: 0.8rem; margin-left: 0.25rem; }
    .admin-depth-chart { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; padding: 0.75rem; background: rgba(255,255,255,0.92); color: #1a1a2e; }
    .admin-position-column { display: flex; flex-direction: column; gap: 0.35rem; min-height: 80px; }
    .admin-position-header { text-align: center; font-weight: 700; font-size: 0.85rem; color: #1a1a2e; padding: 0.3rem; border-bottom: 2px solid #667eea; margin-bottom: 0.2rem; }
    .admin-player-card { background: white; border-radius: 8px; padding: 0.4rem 0.5rem; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.06); transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s; border: 2px solid transparent; cursor: grab; user-select: none; font-size: 0.75rem; }
    .admin-player-card:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: #667eea; }
    .admin-player-card.starter { background: linear-gradient(135deg, #fff 0%, #f0f4ff 100%); border: 2px solid #667eea; }
    .admin-player-card.dragging { opacity: 0.5; cursor: grabbing; }
    .admin-player-card.drag-over { border: 2px dashed #667eea; background: #f0f4ff; }
    .admin-position-column.drag-over { background: rgba(102,126,234,0.1); border-radius: 6px; }
    .admin-player-name { font-weight: 600; font-size: 0.75rem; color: #1a1a2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
    .admin-player-card.two-way { background: #fce4ec; }
    .admin-player-card.ten-day { background: #fff9c4; }
    .admin-player-card.spacer { background: #2a2a4e; border: 1px dashed #444; display: flex; align-items: center; justify-content: center; opacity: 0.6; cursor: grab; position: relative; padding: 0.4rem 0.5rem; }
    .admin-player-card.spacer .spacer-label { color: #666; font-size: 0.65rem; }
    .admin-player-card.spacer .spacer-delete { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #f44; cursor: pointer; font-size: 0.7rem; padding: 2px 4px; line-height: 1; }
    .admin-player-card.spacer .spacer-delete:hover { color: #ff6666; }
    .add-spacer-btn { width: 100%; padding: 3px; margin-top: 4px; background: transparent; border: 1px dashed #444; border-radius: 4px; color: #666; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; }
    .add-spacer-btn:hover { border-color: #888; color: #aaa; background: rgba(255,255,255,0.03); }
    .admin-player-card.injured { background: #fff3e0; }
    .admin-player-card.questionable { background: #ffe0e0; }
    .admin-trade-value { font-size: 0.65rem; font-weight: 600; pointer-events: none; margin-top: 1px; }
    .admin-trade-value.high { color: #16a34a; }
    .admin-trade-value.medium { color: #ca8a04; }
    .admin-trade-value.low { color: #6b7280; }

    @media (max-width: 900px) { .depth-chart, .admin-depth-chart { grid-template-columns: repeat(3, 1fr); } .team-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); } }
    @media (max-width: 600px) { .depth-chart, .admin-depth-chart { grid-template-columns: repeat(2, 1fr); } h1 { font-size: 1.75rem; } .player-image { width: 60px; height: 45px; } }

    /* Export modal */
    .export-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:200; align-items:center; justify-content:center; padding:2rem; }
    .export-modal.active { display:flex; }
    .export-modal-inner { background:#1e2a3a; border-radius:16px; width:100%; max-width:900px; max-height:90vh; display:flex; flex-direction:column; overflow:hidden; }
    .export-modal-header { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.5rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .export-modal-header h3 { font-size:1.1rem; }
    .export-modal-actions { display:flex; gap:0.5rem; }
    .export-modal-actions button { padding:0.5rem 1rem; border-radius:8px; border:none; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.85rem; cursor:pointer; transition:all 0.2s; }
    .copy-btn { background:#667eea; color:white; }
    .copy-btn:hover { background:#5a6fd6; }
    .copy-btn.copied { background:#16a34a; }
    .close-btn { background:rgba(255,255,255,0.1); color:white; }
    .close-btn:hover { background:rgba(255,255,255,0.2); }
    .export-modal textarea { flex:1; background:#0d1117; color:#c9d1d9; border:none; padding:1rem 1.5rem; font-family:'Courier New',monospace; font-size:0.8rem; resize:none; outline:none; line-height:1.5; }
  </style>
</head>
<body>
  <div id="adminBanner" class="admin-banner">
    <span>üîß ADMIN MODE ‚Äî Drag to reorder, changes saved locally</span>
    <span id="saveStatus" class="admin-save-status">‚úì Saved</span>
    <div style="display:flex;gap:0.5rem;">
      <button class="export-btn" onclick="exportHTML(true,0,15)">üì∑ Headshots (ATL-MEM)</button>
      <button class="export-btn" onclick="exportHTML(true,15,30)">üì∑ Headshots (MIA-WAS)</button>
      <button class="export-btn" onclick="exportHTML(false,0,15)">üìã Compact (ATL-MEM)</button>
      <button class="export-btn" onclick="exportHTML(false,15,30)">üìã Compact (MIA-WAS)</button>
    </div>
  </div>
  <div class="container">
    <header><h1>üèÄ NBA Depth Charts</h1><p class="subtitle">Ranked by Trade Value</p></header>
    <div id="loading" class="loading"><div class="loading-spinner"></div><p>Loading NBA data...</p></div>
    <div id="teamGrid" class="team-grid" style="display:none;"></div>
    <div id="depthChartContainer" class="depth-chart-container">
      <a href="?" class="back-btn">‚Üê All Teams</a>
      <div class="team-header"><img id="teamLogo" class="team-header-logo" src="" alt=""><h2 id="teamName" class="team-header-name"></h2></div>
      <p class="drag-hint">üí° Drag players to rearrange or move between positions</p>
      <div id="depthChart" class="depth-chart"></div>
    </div>
    <div id="adminAllTeams" class="admin-all-teams">
      <p class="drag-hint">üí° Drag players to rearrange ‚Äî changes auto-save to your browser</p>
      <div id="adminTeamsList"></div>
    </div>

  <!-- Export Modal -->
  <div id="exportModal" class="export-modal" onclick="if(event.target===this)closeExportModal()">
    <div class="export-modal-inner">
      <div class="export-modal-header">
        <h3 id="exportModalTitle">üìã Export HTML</h3>
        <div class="export-modal-actions">
          <button class="copy-btn" onclick="copyExportCode()">üìã Copy to Clipboard</button>
          <button class="copy-btn" onclick="downloadExportCode()" style="margin-left:8px;">üíæ Download .txt</button>
          <button class="close-btn" onclick="closeExportModal()">‚úï Close</button>
        </div>
      </div>
      <textarea id="exportCode" readonly></textarea>
    </div>
  </div>
    <div id="error" class="error" style="display:none;"></div>
    <footer>Trade values computed using <a href="https://hoopsmatic.com" target="_blank">HoopsMatic</a> methodology</footer>
  </div>
<script>
// =====================================================
// LOCALSTORAGE PERSISTENCE (replaces Firebase)
// =====================================================
const STORAGE_KEY = 'depthcharts_orders';
const ADMIN_KEY = 'hoopsmatic2025';
let isAdmin = false;

function loadAllOrders() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
  catch(e) { return {}; }
}
function saveAllOrders(orders) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(orders)); } catch(e) { console.error('Storage error:', e); }
}
function saveTeamOrder(teamAbbrev, container) {
  const columns = container.querySelectorAll('[class*="position-column"]');
  const order = {};
  columns.forEach(col => {
    const pos = col.dataset.position;
    if (!pos) return;
    order[pos] = [];
    col.querySelectorAll('[class*="player-card"]').forEach(card => {
      if (card.dataset.player === '__SPACER__') order[pos].push('__SPACER__');
      else if (card.dataset.player) order[pos].push(card.dataset.player);
    });
  });
  const all = loadAllOrders();
  all[teamAbbrev] = order;
  saveAllOrders(all);
  showSaveStatus();
}
function loadTeamOrder(t) { return (loadAllOrders())[t] || null; }
function showSaveStatus() {
  const el = document.getElementById('saveStatus');
  el.textContent = '‚úì Saved';
  el.classList.add('visible');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('visible'), 2000);
}

// =====================================================
// TEAMS & ALIASES
// =====================================================
const NBA_TEAMS = [
  {abbrev:'ATL',name:'Atlanta Hawks',logo:'https://cdn.nba.com/logos/nba/1610612737/global/L/logo.svg'},
  {abbrev:'BOS',name:'Boston Celtics',logo:'https://cdn.nba.com/logos/nba/1610612738/global/L/logo.svg'},
  {abbrev:'BKN',name:'Brooklyn Nets',logo:'https://cdn.nba.com/logos/nba/1610612751/global/L/logo.svg'},
  {abbrev:'CHA',name:'Charlotte Hornets',logo:'https://cdn.nba.com/logos/nba/1610612766/global/L/logo.svg'},
  {abbrev:'CHI',name:'Chicago Bulls',logo:'https://cdn.nba.com/logos/nba/1610612741/global/L/logo.svg'},
  {abbrev:'CLE',name:'Cleveland Cavaliers',logo:'https://cdn.nba.com/logos/nba/1610612739/global/L/logo.svg'},
  {abbrev:'DAL',name:'Dallas Mavericks',logo:'https://cdn.nba.com/logos/nba/1610612742/global/L/logo.svg'},
  {abbrev:'DEN',name:'Denver Nuggets',logo:'https://cdn.nba.com/logos/nba/1610612743/global/L/logo.svg'},
  {abbrev:'DET',name:'Detroit Pistons',logo:'https://cdn.nba.com/logos/nba/1610612765/global/L/logo.svg'},
  {abbrev:'GSW',name:'Golden State Warriors',logo:'https://cdn.nba.com/logos/nba/1610612744/global/L/logo.svg'},
  {abbrev:'HOU',name:'Houston Rockets',logo:'https://cdn.nba.com/logos/nba/1610612745/global/L/logo.svg'},
  {abbrev:'IND',name:'Indiana Pacers',logo:'https://cdn.nba.com/logos/nba/1610612754/global/L/logo.svg'},
  {abbrev:'LAC',name:'LA Clippers',logo:'https://cdn.nba.com/logos/nba/1610612746/global/L/logo.svg'},
  {abbrev:'LAL',name:'Los Angeles Lakers',logo:'https://cdn.nba.com/logos/nba/1610612747/global/L/logo.svg'},
  {abbrev:'MEM',name:'Memphis Grizzlies',logo:'https://cdn.nba.com/logos/nba/1610612763/global/L/logo.svg'},
  {abbrev:'MIA',name:'Miami Heat',logo:'https://cdn.nba.com/logos/nba/1610612748/global/L/logo.svg'},
  {abbrev:'MIL',name:'Milwaukee Bucks',logo:'https://cdn.nba.com/logos/nba/1610612749/global/L/logo.svg'},
  {abbrev:'MIN',name:'Minnesota Timberwolves',logo:'https://cdn.nba.com/logos/nba/1610612750/global/L/logo.svg'},
  {abbrev:'NOP',name:'New Orleans Pelicans',logo:'https://cdn.nba.com/logos/nba/1610612740/global/L/logo.svg'},
  {abbrev:'NYK',name:'New York Knicks',logo:'https://cdn.nba.com/logos/nba/1610612752/global/L/logo.svg'},
  {abbrev:'OKC',name:'Oklahoma City Thunder',logo:'https://cdn.nba.com/logos/nba/1610612760/global/L/logo.svg'},
  {abbrev:'ORL',name:'Orlando Magic',logo:'https://cdn.nba.com/logos/nba/1610612753/global/L/logo.svg'},
  {abbrev:'PHI',name:'Philadelphia 76ers',logo:'https://cdn.nba.com/logos/nba/1610612755/global/L/logo.svg'},
  {abbrev:'PHX',name:'Phoenix Suns',logo:'https://cdn.nba.com/logos/nba/1610612756/global/L/logo.svg'},
  {abbrev:'POR',name:'Portland Trail Blazers',logo:'https://cdn.nba.com/logos/nba/1610612757/global/L/logo.svg'},
  {abbrev:'SAC',name:'Sacramento Kings',logo:'https://cdn.nba.com/logos/nba/1610612758/global/L/logo.svg'},
  {abbrev:'SAS',name:'San Antonio Spurs',logo:'https://cdn.nba.com/logos/nba/1610612759/global/L/logo.svg'},
  {abbrev:'TOR',name:'Toronto Raptors',logo:'https://cdn.nba.com/logos/nba/1610612761/global/L/logo.svg'},
  {abbrev:'UTA',name:'Utah Jazz',logo:'https://cdn.nba.com/logos/nba/1610612762/global/L/logo.svg'},
  {abbrev:'WAS',name:'Washington Wizards',logo:'https://cdn.nba.com/logos/nba/1610612764/global/L/logo.svg'}
];
const TEAM_ALIASES = {
  'Atlanta':'ATL','Hawks':'ATL','Boston':'BOS','Celtics':'BOS','Brooklyn':'BKN','Nets':'BKN',
  'Charlotte':'CHA','Hornets':'CHA','Chicago':'CHI','Bulls':'CHI','Cleveland':'CLE','Cavaliers':'CLE','Cavs':'CLE',
  'Dallas':'DAL','Mavericks':'DAL','Mavs':'DAL','Denver':'DEN','Nuggets':'DEN','Detroit':'DET','Pistons':'DET',
  'Golden State':'GSW','Warriors':'GSW','Houston':'HOU','Rockets':'HOU','Indiana':'IND','Pacers':'IND',
  'LA Clippers':'LAC','Clippers':'LAC','Los Angeles Lakers':'LAL','Lakers':'LAL','LA Lakers':'LAL',
  'Memphis':'MEM','Grizzlies':'MEM','Miami':'MIA','Heat':'MIA','Milwaukee':'MIL','Bucks':'MIL',
  'Minnesota':'MIN','Timberwolves':'MIN','Wolves':'MIN','New Orleans':'NOP','Pelicans':'NOP',
  'New York':'NYK','Knicks':'NYK','Oklahoma City':'OKC','Thunder':'OKC','Orlando':'ORL','Magic':'ORL',
  'Philadelphia':'PHI','76ers':'PHI','Sixers':'PHI','Phoenix':'PHX','Suns':'PHX',
  'Portland':'POR','Trail Blazers':'POR','Blazers':'POR','Sacramento':'SAC','Kings':'SAC',
  'San Antonio':'SAS','Spurs':'SAS','Toronto':'TOR','Raptors':'TOR','Utah':'UTA','Jazz':'UTA',
  'Washington':'WAS','Wizards':'WAS'
};

// =====================================================
// DATA URLs
// =====================================================
const TV_SHEET_ID = '2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7';
const TV_GID = '1310971167';
const TV_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${TV_SHEET_ID}/pub?gid=${TV_GID}&single=true&output=csv`;
const ROSTER_GID = '0';
const ROSTER_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${TV_SHEET_ID}/pub?gid=${ROSTER_GID}&single=true&output=csv`;

let allPlayers = [], tradeValueMap = new Map(), draggedElement = null;

// =====================================================
// CSV PARSER
// =====================================================
function parseCSV(text) {
  const rows = []; let cur = '', inQ = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (inQ) { if (c === '"' && text[i+1] === '"') { cur += '"'; i++; } else if (c === '"') inQ = false; else cur += c; }
    else { if (c === '"') inQ = true; else if (c === ',') { row.push(cur.trim()); cur = ''; }
    else if (c === '\n' || c === '\r') { if (c === '\r' && text[i+1] === '\n') i++; row.push(cur.trim()); if (row.length > 1 || row[0] !== '') rows.push(row); row = []; cur = ''; }
    else cur += c; }
  }
  if (cur || row.length > 0) { row.push(cur.trim()); if (row.length > 1 || row[0] !== '') rows.push(row); }
  return rows;
}

// =====================================================
// TRADE VALUE COMPUTATION
// =====================================================
function computeTradeValues(csvText) {
  const rows = parseCSV(csvText); const roster = [], historical = []; let todayStr = null;
  for (const row of rows.slice(1)) {
    while (row.length < 22) row.push('');
    if (row[18] && !todayStr) todayStr = row[18];
    if (row[0] && row[1]) roster.push({ player: row[1].trim(), rat365: parseFloat(row[2])||0, salary: parseInt(row[3].replace(/[$,]/g,''))||0, birthday: row[4]||'', draftPick: parseInt(row[20])||null });
    if (row[6] && row[7]) { const g = parseInt(row[9])||0; if (g > 0) historical.push({ year: row[6], player: row[7].trim(), totalRat: parseFloat(row[8].replace(/,/g,''))||0, games: g }); }
  }
  const playerHist = {}; for (const h of historical) { const k = h.player.toLowerCase(); if (!playerHist[k]) playerHist[k] = []; playerHist[k].push(h); }
  const WEIGHTS = {'2025-26':1.0,'2024-25':0.6,'2023-24':0.36,'2022-23':0.216,'2021-22':0.1296};
  const EXPECTED = {'2021-22':82,'2022-23':82,'2023-24':82,'2024-25':82,'2025-26':48};
  const EXP=1.8, BETA=0.8, MAX_MULT=1.4, MIN_PCT=0.40, WM_W=0.85, RAT_W=0.15, AGE_BONUS=1.0, OLD_TH=35, OLD_PEN=0.03;
  for (const p of roster) {
    const hist = playerHist[p.player.toLowerCase()]||[]; let num=0, den=0;
    for (const h of hist) { const w = WEIGHTS[h.year]||0; if (w<=0||h.games<=0) continue; let pg = h.totalRat/h.games; const exp = EXPECTED[h.year]||82; if (h.games/exp >= MIN_PCT) pg *= Math.min(MAX_MULT, Math.pow(exp/h.games, BETA)); num += pg*w*h.games; den += w*h.games; }
    p.watermark = den > 0 ? num/den : 0;
    const cur = hist.filter(h => h.year==='2025-26'); const cg = cur.reduce((s,h) => s+h.games, 0);
    p.rat365adj = (cg > 0 && cg/48 >= MIN_PCT) ? p.rat365 * Math.min(MAX_MULT, Math.pow(48/cg, BETA)) : p.rat365;
  }
  const pd = s => { if (!s) return null; const p = s.split('/'); return p.length===3 ? new Date(+p[2],+p[0]-1,+p[1]) : null; };
  const today = pd(todayStr)||new Date(); const ages = [];
  for (const p of roster) { const bd = pd(p.birthday); p.age = bd ? (today-bd)/(365.25*864e5) : null; if (p.age) ages.push(p.age); }
  const avgAge = ages.length > 0 ? ages.reduce((a,b)=>a+b,0)/ages.length : 26;
  const maxDev = avgAge - Math.min(...ages);
  for (const p of roster) {
    if (p.age!==null && p.age < avgAge) p.ageMult = 1.0 + AGE_BONUS*(avgAge-p.age)/maxDev;
    else if (p.age!==null && p.age >= OLD_TH) p.ageMult = Math.max(0.5, 1.0-OLD_PEN*(p.age-OLD_TH));
    else p.ageMult = 1.0;
  }
  const tSP = roster.reduce((s,p)=>s+p.salary,0);
  const tWM = roster.reduce((s,p)=>s+Math.pow(Math.max(p.watermark,0),EXP),0);
  const tRAT = roster.reduce((s,p)=>s+Math.pow(Math.max(p.rat365adj,0),EXP),0);
  for (const p of roster) {
    const tvWM = tWM>0 ? (Math.pow(Math.max(p.watermark,0),EXP)/tWM)*tSP : 0;
    const tvRAT = tRAT>0 ? (Math.pow(Math.max(p.rat365adj,0),EXP)/tRAT)*tSP : 0;
    p.tvWithAge = (WM_W*tvWM + RAT_W*tvRAT) * p.ageMult;
  }
  const tWA = roster.reduce((s,p)=>s+p.tvWithAge,0); const result = new Map();
  for (const p of roster) {
    const baseTV = tWA>0 ? Math.round((p.tvWithAge/tWA)*tSP) : 0; let bonus = 0;
    if (p.age!==null && p.age<25 && p.draftPick && p.draftPick>=1 && p.draftPick<=60) { bonus = Math.round(7e6 * Math.exp(-0.05*(p.draftPick-1)) * Math.exp(-0.5*Math.max(0,p.age-18.82))); }
    result.set(p.player.toLowerCase(), baseTV+bonus);
  }
  return result;
}

// =====================================================
// ROSTER PARSER (salary, headshot, status, injury)
// =====================================================
function parseRosterCSV(csvText) {
  const rows = parseCSV(csvText); if (rows.length < 2) return [];
  const hdr = rows[0]; const col = n => hdr.findIndex(h => h.toUpperCase() === n.toUpperCase());
  const PI=col('PLAYER'), TI=col('TEAM'), SI=col('2026'), STI=col('ST 25-26'), OI=col('OUT?'), RI=col('REASON'), LI=col('LOGO'), HI=col('HEADSHOT'), POI=col('POSITION');
  if (PI<0||TI<0) return [];
  const players = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i]; const name = r[PI]?.trim(); const team = r[TI]?.trim();
    if (!name||!team) continue;
    const abbrev = TEAM_ALIASES[team]||team;
    const pos = POI>=0 ? (r[POI]?.trim()||'SF') : 'SF';
    const headshot = HI>=0 ? (r[HI]?.trim()||'') : '';
    const tv = tradeValueMap.get(name.toLowerCase())||0;
    const salary = SI>=0 ? (parseInt((r[SI]||'0').replace(/[$,]/g,''))||0) : 0;
    const status = STI>=0 ? (r[STI]?.trim()||'GUARANTEED') : 'GUARANTEED';
    const injury = OI>=0 ? (r[OI]?.trim()||'') : '';
    const reason = RI>=0 ? (r[RI]?.trim()||'') : '';
    const logo = LI>=0 ? (r[LI]?.trim()||'') : '';
    let color = 'normal';
    if (status==='TWO-WAY'||status==='10-DAY') color = 'twoway';
    if (injury==='Out'||injury==='Doubtful') color = 'injured';
    else if (injury==='Questionable') color = 'questionable';
    players.push({name, team:abbrev, position:pos, tradeValue:tv, headshot, salary, contractStatus:status, injuryStatus:injury, injuryReason:reason, colorCode:color, teamLogo:logo});
  }
  return players;
}

// =====================================================
// FORMATTING UTILS
// =====================================================
function fmtTV(tv) { if (tv>=1e6) return '$'+(tv/1e6).toFixed(1)+'M'; if (tv>=1e3) return '$'+Math.round(tv/1e3)+'K'; return '$'+tv.toLocaleString(); }
function fmtSal(s) { if (s>=1e6) return '$'+(s/1e6).toFixed(1)+'M'; if (s>=1e3) return '$'+Math.round(s/1e3)+'K'; return '$'+s.toLocaleString(); }
function fmtSalFull(s) { return '$'+s.toLocaleString('en-US'); }
function valClass(tv) { return tv>=2e7?'high':tv>=5e6?'medium':'low'; }
function initials(n) { return n.split(' ').map(w=>w[0]).join(''); }

// =====================================================
// RENDER TEAM GRID
// =====================================================
function renderTeamGrid() {
  const g = document.getElementById('teamGrid');
  g.innerHTML = NBA_TEAMS.map(t=>`<a href="?team=${t.abbrev}" class="team-card"><img class="team-logo" src="${t.logo}" alt="${t.name}" onerror="this.style.opacity='0.3'"><div class="team-name">${t.name}</div><div class="team-abbrev">${t.abbrev}</div></a>`).join('');
  g.style.display = 'grid';
}

// =====================================================
// BUILD POSITION MAP (shared by single-team & admin)
// =====================================================
function buildPositionMap(teamPlayers, savedOrder) {
  const positions = ['PG','SG','SF','PF','C'];
  const byPos = {}; positions.forEach(p => byPos[p] = []);
  if (savedOrder) {
    const pm = {}; teamPlayers.forEach(p => pm[p.name] = p);
    const placed = new Set();
    positions.forEach(pos => { if (savedOrder[pos]) savedOrder[pos].forEach(n => {
      if (n === '__SPACER__') { byPos[pos].push('__SPACER__'); }
      else if (pm[n]&&!placed.has(n)) { byPos[pos].push(pm[n]); placed.add(n); }
    }); });
    teamPlayers.forEach(p => { if (!placed.has(p.name)) byPos[positions.includes(p.position)?p.position:'SF'].push(p); });
  } else {
    teamPlayers.forEach(p => byPos[positions.includes(p.position)?p.position:'SF'].push(p));
    positions.forEach(pos => byPos[pos].sort((a,b) => b.tradeValue - a.tradeValue));
  }
  return byPos;
}

// =====================================================
// SINGLE TEAM VIEW
// =====================================================
function renderDepthChart(teamAbbrev) {
  const team = NBA_TEAMS.find(t=>t.abbrev===teamAbbrev);
  if (!team) { document.getElementById('error').textContent='Team not found'; document.getElementById('error').style.display='block'; return; }
  const tp = allPlayers.filter(p=>p.team===teamAbbrev);
  if (!tp.length) { document.getElementById('error').textContent=`No players for ${team.name}`; document.getElementById('error').style.display='block'; return; }
  document.getElementById('teamLogo').src = team.logo;
  document.getElementById('teamName').textContent = team.name;
  document.title = `${team.name} Depth Chart`;
  const positions = ['PG','SG','SF','PF','C'];
  const byPos = buildPositionMap(tp, loadTeamOrder(teamAbbrev));
  let html = '';
  positions.forEach(pos => {
    html += `<div class="position-column" data-position="${pos}"><div class="position-header">${pos}</div>`;
    let firstReal = true;
    byPos[pos].forEach((p,i) => {
      if (p === '__SPACER__') {
        html += `<div class="player-card spacer" draggable="true" data-player="__SPACER__">
          <div class="player-image"><span class="initials" style="visibility:hidden;">&nbsp;</span></div>
          <div class="player-name" style="color:#444;">‚Äî</div>
          <div class="trade-value" style="visibility:hidden;">&nbsp;</div></div>`;
      } else {
        html += `<div class="player-card ${firstReal?'starter':''}" draggable="true" data-player="${p.name}" data-tv="${p.tradeValue}">
          <div class="player-image">${p.headshot?`<img src="${p.headshot}" alt="${p.name}" onerror="this.parentElement.innerHTML='<span class=\\'initials\\'>${initials(p.name)}</span>'">`:`<span class="initials">${initials(p.name)}</span>`}</div>
          <div class="player-name">${p.name}</div>
          <div class="trade-value ${valClass(p.tradeValue)}">${fmtTV(p.tradeValue)}</div></div>`;
        firstReal = false;
      }
    });
    html += '</div>';
  });
  document.getElementById('depthChart').innerHTML = html;
  document.getElementById('depthChartContainer').classList.add('active');
  setupDragDrop(document.getElementById('depthChart'), teamAbbrev, false);
}

// =====================================================
// ADMIN ALL-TEAMS VIEW
// =====================================================
function renderAdminAllTeams() {
  document.getElementById('adminBanner').classList.add('active');
  document.title = 'NBA Depth Charts ‚Äî ADMIN';
  const container = document.getElementById('adminTeamsList');
  const positions = ['PG','SG','SF','PF','C'];
  const savedOrders = loadAllOrders();
  let html = '';
  for (const team of NBA_TEAMS) {
    const tp = allPlayers.filter(p=>p.team===team.abbrev);
    if (!tp.length) continue;
    const byPos = buildPositionMap(tp, savedOrders[team.abbrev]||null);
    html += `<div class="admin-team-row" data-team="${team.abbrev}">
      <div class="admin-team-row-header"><img class="admin-team-row-logo" src="${team.logo}" alt="${team.name}" onerror="this.style.opacity='0.3'"><span class="admin-team-row-name">${team.name}</span><span class="admin-team-row-abbrev">${team.abbrev}</span></div>
      <div class="admin-depth-chart" data-team="${team.abbrev}">`;
    positions.forEach(pos => {
      html += `<div class="admin-position-column" data-position="${pos}"><div class="admin-position-header">${pos}</div>`;
      let firstReal = true;
      byPos[pos].forEach((p,i) => {
        if (p === '__SPACER__') {
          html += `<div class="admin-player-card spacer" draggable="true" data-player="__SPACER__"><div><div class="admin-player-name" style="color:#666;">‚Äî blank ‚Äî</div><div class="admin-trade-value" style="visibility:hidden;">&nbsp;</div></div><button class="spacer-delete" onclick="removeSpacer(this)" title="Remove spacer">‚úï</button></div>`;
        } else {
          const sc = p.contractStatus==='10-DAY'?'ten-day':p.colorCode==='twoway'?'two-way':p.colorCode==='injured'?'injured':p.colorCode==='questionable'?'questionable':'';
          html += `<div class="admin-player-card ${firstReal?'starter':''} ${sc}" draggable="true" data-player="${p.name}" data-tv="${p.tradeValue}"><div class="admin-player-name">${p.name}</div><div class="admin-trade-value ${valClass(p.tradeValue)}">${fmtTV(p.tradeValue)}</div></div>`;
          firstReal = false;
        }
      });
      html += `<button class="add-spacer-btn" onclick="addSpacer(this)" data-team="${team.abbrev}">+ spacer</button>`;
      html += '</div>';
    });
    html += '</div></div>';
  }
  container.innerHTML = html;
  document.getElementById('adminAllTeams').classList.add('active');
  document.querySelectorAll('.admin-depth-chart').forEach(c => setupDragDrop(c, c.dataset.team, true));
}

// =====================================================
// UNIFIED DRAG AND DROP
// =====================================================
function setupDragDrop(container, teamAbbrev, isAdminView) {
  const cardSel = isAdminView ? '.admin-player-card' : '.player-card';
  const colSel = isAdminView ? '.admin-position-column' : '.position-column';

  container.querySelectorAll(cardSel).forEach(card => {
    card.addEventListener('dragstart', function(e) {
      draggedElement = this; this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.player);
    });
    card.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      draggedElement = null;
      // Update starter highlights (skip spacers)
      container.querySelectorAll(colSel).forEach(col => {
        let firstReal = true;
        col.querySelectorAll(cardSel).forEach(c => {
          if (c.classList.contains('spacer')) { c.classList.remove('starter'); return; }
          c.classList.toggle('starter', firstReal);
          firstReal = false;
        });
      });
      // Save
      saveTeamOrder(teamAbbrev, container);
    });
    card.addEventListener('dragover', function(e) { e.preventDefault(); if (this !== draggedElement) this.classList.add('drag-over'); });
    card.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
    card.addEventListener('drop', function(e) {
      e.preventDefault(); e.stopPropagation(); this.classList.remove('drag-over');
      if (this !== draggedElement && draggedElement) {
        const col = this.parentElement;
        const r = this.getBoundingClientRect();
        if (e.clientY < r.top + r.height/2) col.insertBefore(draggedElement, this);
        else col.insertBefore(draggedElement, this.nextSibling);
      }
    });
  });

  container.querySelectorAll(colSel).forEach(col => {
    col.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('drag-over'); });
    col.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
    col.addEventListener('drop', function(e) {
      e.preventDefault(); this.classList.remove('drag-over');
      if (draggedElement && !e.target.matches(cardSel)) this.appendChild(draggedElement);
    });
  });
}

// =====================================================
// SPACER MANAGEMENT
// =====================================================
function addSpacer(btn) {
  const col = btn.parentElement;
  const teamAbbrev = btn.dataset.team;
  const spacer = document.createElement('div');
  spacer.className = 'admin-player-card spacer';
  spacer.draggable = true;
  spacer.dataset.player = '__SPACER__';
  spacer.innerHTML = '<div><div class="admin-player-name" style="color:#666;">‚Äî blank ‚Äî</div><div class="admin-trade-value" style="visibility:hidden;">&nbsp;</div></div><button class="spacer-delete" onclick="removeSpacer(this)" title="Remove spacer">‚úï</button>';
  col.insertBefore(spacer, btn);
  // Attach drag events to new spacer
  const chart = col.closest('.admin-depth-chart');
  attachCardDrag(spacer, chart, teamAbbrev);
  saveTeamOrder(teamAbbrev, chart);
}

function removeSpacer(deleteBtn) {
  const spacer = deleteBtn.parentElement;
  const chart = spacer.closest('.admin-depth-chart');
  const teamAbbrev = chart.dataset.team;
  spacer.remove();
  saveTeamOrder(teamAbbrev, chart);
}

function attachCardDrag(card, container, teamAbbrev) {
  card.addEventListener('dragstart', function(e) {
    draggedElement = this; this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.player);
  });
  card.addEventListener('dragend', function() {
    this.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    draggedElement = null;
    container.querySelectorAll('.admin-position-column').forEach(col => {
      col.querySelectorAll('.admin-player-card').forEach((c,i) => c.classList.toggle('starter', i===0 && !c.classList.contains('spacer')));
    });
    saveTeamOrder(teamAbbrev, container);
  });
  card.addEventListener('dragover', function(e) { e.preventDefault(); if (this !== draggedElement) this.classList.add('drag-over'); });
  card.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
  card.addEventListener('drop', function(e) {
    e.preventDefault(); e.stopPropagation(); this.classList.remove('drag-over');
    if (this !== draggedElement && draggedElement) {
      const col = this.parentElement;
      const r = this.getBoundingClientRect();
      if (e.clientY < r.top + r.height/2) col.insertBefore(draggedElement, this);
      else col.insertBefore(draggedElement, this.nextSibling);
    }
  });
}

// =====================================================
// EXPORT HTML
// =====================================================
function exportHTML(withHeadshots, startIdx, endIdx) {
  const positions = ['PG','SG','SF','PF','C'];
  const playerMap = {}; allPlayers.forEach(p => playerMap[p.name] = p);
  const teamOrders = {};
  document.querySelectorAll('.admin-depth-chart').forEach(chart => {
    const ta = chart.dataset.team; const order = {};
    chart.querySelectorAll('.admin-position-column').forEach(col => {
      const pos = col.dataset.position; if (!pos) return; order[pos] = [];
      col.querySelectorAll('.admin-player-card').forEach(card => {
        if (card.dataset.player === '__SPACER__') order[pos].push('__SPACER__');
        else if (card.dataset.player) order[pos].push(card.dataset.player);
      });
    });
    teamOrders[ta] = order;
  });

  const td = 'border:none; padding:4px; text-align:center;';
  const imgS = 'display:block;width:80px;height:80px;object-fit:cover;object-position:center;margin:0 auto;';

  // Single outer wrapper div ‚Äî matches Google Sheets format exactly
  let out = '<div style="font-family:sans-serif; max-width:800px; margin:0 auto; overflow-x:auto; font-size:16px; text-align:center;">\n';

  const teamsSlice = NBA_TEAMS.slice(startIdx, endIdx);
  for (const team of teamsSlice) {
    const order = teamOrders[team.abbrev];
    if (!order) continue;
    const posCols = {}; let maxRows = 0;
    positions.forEach(pos => {
      const names = order[pos]||[];
      // Preserve exact order including spacers ‚Äî no auto-sorting
      posCols[pos] = names.map(n => {
        if (n === '__SPACER__') return null;
        return playerMap[n] || null;
      });
      if (posCols[pos].length > maxRows) maxRows = posCols[pos].length;
    });
    if (maxRows < 3) maxRows = 3;
    maxRows += 1; // Always include trailing empty row like Google Sheets

    // Team title (bare div, no wrapper)
    out += `<div style="text-align:center; font-size:1.2em; margin-bottom:0.5em;">\n`;
    out += `<strong>${team.name.toUpperCase()}</strong>\n`;
    out += `</div>\n`;
    out += `<table style="width:100%; text-align:center; border-collapse:collapse; font-size:12px;">\n`;

    // Position headers
    out += `   \n<tbody><tr style="background-color: #f2f2f2;">\n`;
    positions.forEach(pos => {
      out += `<th style="${td}">${pos}</th>\n`;
    });
    out += `</tr>\n    \n   \n`;

    // Each depth row = 2 or 3 table rows: [headshots], names, salaries
    for (let r = 0; r < maxRows; r++) {
      const rowPlayers = positions.map(pos => posCols[pos][r] || null);

      // Per-cell color: pink for twoway, yellow for 10-day, lightcoral for injured, lightsalmon for questionable
      const cellColors = rowPlayers.map(p => {
        if (!p) return null;
        if (p.contractStatus === '10-DAY') return 'yellow';
        if (p.colorCode === 'twoway') return 'pink';
        if (p.colorCode === 'injured') return 'lightcoral';
        if (p.colorCode === 'questionable') return '#f5b7b1';
        return null;
      });

      if (withHeadshots) {
        // Headshot row (white background)
        out += `\n      <tr style="background-color:#fff; text-align:center;">\n`;
        positions.forEach((pos, i) => {
          const p = rowPlayers[i];
          if (p && p.headshot) {
            out += `<td style="${td}"><img src="${p.headshot}" style="${imgS}"/></td>\n`;
          } else {
            out += `<td style="${td}"></td>\n`;
          }
        });
        out += `</tr>\n`;
      }

      // Name row ‚Äî bg on <tr> is #f2f2f2, per-cell override for twoway/injured
      out += `\n<tr style="background-color: #f2f2f2;">\n`;
      positions.forEach((pos, i) => {
        const p = rowPlayers[i];
        const cc = cellColors[i];
        const bgAttr = cc ? `background-color:${cc};` : '';
        if (p) {
          out += `<td style="${td} ${bgAttr}" ><strong>${p.name}</strong></td>\n`;
        } else {
          out += `<td style="${td} " ><strong></strong></td>\n`;
        }
      });
      out += `</tr>\n`;

      // Salary row ‚Äî same pattern
      out += `\n<tr style="background-color: #f2f2f2;">\n`;
      positions.forEach((pos, i) => {
        const p = rowPlayers[i];
        const cc = cellColors[i];
        const bgAttr = cc ? `background-color:${cc};` : '';
        if (p) {
          out += `<td style="${td}${bgAttr}">${fmtSalFull(p.salary)}</td>\n`;
        } else {
          out += `<td style="${td}"></td>\n`;
        }
      });
      out += `</tr>\n`;
    }

    out += `   \n</tbody></table><br>\n`;
  }

  out += '</div>\n';

  const blockLabel = startIdx === 0 ? 'ATL‚ÄìMEM' : 'MIA‚ÄìWAS';
  const modeLabel = withHeadshots ? 'üì∑ Headshots' : 'üìã Compact';
  document.getElementById('exportCode').value = out;
  document.getElementById('exportModalTitle').textContent = `${modeLabel} ‚Äî ${blockLabel} (${teamsSlice.length} teams)`;
  document.getElementById('exportModal').classList.add('active');
}

function copyExportCode() {
  const text = document.getElementById('exportCode').value;
  // Force plain text only ‚Äî no HTML clipboard metadata
  const blob = new Blob([text], {type: 'text/plain'});
  navigator.clipboard.write([new ClipboardItem({'text/plain': blob})]).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '‚úì Copied!'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã Copy to Clipboard'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    // Fallback
    const ta = document.getElementById('exportCode');
    ta.select(); ta.setSelectionRange(0, ta.value.length);
    document.execCommand('copy');
  });
}

function downloadExportCode() {
  const text = document.getElementById('exportCode').value;
  const blob = new Blob([text], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'depth-charts-export.txt';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function closeExportModal() { document.getElementById('exportModal').classList.remove('active'); }

// =====================================================
// INIT
// =====================================================
async function init() {
  const params = new URLSearchParams(window.location.search);
  const teamParam = params.get('team')?.toUpperCase();
  const adminParam = params.get('admin');
  isAdmin = (adminParam === ADMIN_KEY);
  try {
    const [tvR, rR] = await Promise.all([fetch(TV_CSV_URL), fetch(ROSTER_CSV_URL)]);
    if (!tvR.ok || !rR.ok) throw new Error('Failed to fetch data');
    const [tvText, rText] = await Promise.all([tvR.text(), rR.text()]);
    tradeValueMap = computeTradeValues(tvText);
    allPlayers = parseRosterCSV(rText);
    document.getElementById('loading').style.display = 'none';
    if (isAdmin && !teamParam) renderAdminAllTeams();
    else if (teamParam && NBA_TEAMS.some(t=>t.abbrev===teamParam)) renderDepthChart(teamParam);
    else renderTeamGrid();
  } catch (err) {
    console.error('Error:', err);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').textContent = 'Error loading data. Please refresh.';
    document.getElementById('error').style.display = 'block';
  }
}
init();
</script>
</body>
</html>
