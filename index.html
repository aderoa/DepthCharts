<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBA Depth Charts by Trade Value</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: white;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    
    header { text-align: center; margin-bottom: 2rem; }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { color: #8892b0; font-size: 1.1rem; }
    
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 1.5rem;
      transition: all 0.2s;
    }
    
    .back-btn:hover { background: rgba(255,255,255,0.2); }
    
    /* Admin banner */
    .admin-banner {
      display: none;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #1a1a2e;
      text-align: center;
      padding: 0.5rem 1rem;
      font-weight: 700;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
      z-index: 100;
      letter-spacing: 0.5px;
    }
    
    .admin-banner.active { display: block; }
    
    .admin-save-status {
      display: inline-block;
      margin-left: 1rem;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .admin-save-status.visible { opacity: 1; }
    
    /* Team Grid */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
    }
    
    .team-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: white;
    }
    
    .team-card:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    
    .team-logo {
      width: 56px;
      height: 56px;
      margin: 0 auto 0.75rem;
      object-fit: contain;
    }
    
    .team-name { font-weight: 600; font-size: 0.95rem; }
    .team-abbrev { color: #8892b0; font-size: 0.8rem; margin-top: 0.25rem; }
    
    /* Single team Depth Chart */
    .depth-chart-container { display: none; }
    .depth-chart-container.active { display: block; }
    
    .team-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .team-header-logo { width: 72px; height: 72px; object-fit: contain; }
    .team-header-name { font-size: 1.75rem; font-weight: 700; }
    
    .drag-hint {
      text-align: center;
      color: #8892b0;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    
    .depth-chart {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 1.25rem;
      color: #1a1a2e;
    }
    
    .position-column {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 200px;
    }
    
    .position-header {
      text-align: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: #1a1a2e;
      padding: 0.5rem;
      border-bottom: 3px solid #667eea;
      margin-bottom: 0.25rem;
    }
    
    .player-card {
      background: white;
      border-radius: 12px;
      padding: 0.75rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      border: 2px solid transparent;
      cursor: grab;
      user-select: none;
    }
    
    .player-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border-color: #667eea;
    }
    
    .player-card.starter {
      background: linear-gradient(135deg, #fff 0%, #f0f4ff 100%);
      border: 2px solid #667eea;
    }
    
    .player-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .player-card.drag-over {
      border: 2px dashed #667eea;
      background: #f0f4ff;
    }
    
    .position-column.drag-over {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
    }
    
    .player-image {
      width: 80px;
      height: 60px;
      margin: 0 auto 0.5rem;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      pointer-events: none;
    }
    
    .player-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .player-image .initials {
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
    }
    
    .player-name {
      font-weight: 600;
      font-size: 0.8rem;
      color: #1a1a2e;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none;
    }
    
    .trade-value {
      font-size: 0.8rem;
      font-weight: 600;
      pointer-events: none;
    }
    
    .trade-value.high { color: #16a34a; }
    .trade-value.medium { color: #ca8a04; }
    .trade-value.low { color: #6b7280; }
    
    .loading { text-align: center; padding: 4rem 2rem; }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error { text-align: center; padding: 2rem; color: #f87171; }
    
    footer {
      text-align: center;
      margin-top: 2rem;
      padding: 1rem;
      color: #8892b0;
      font-size: 0.9rem;
    }
    
    footer a { color: #667eea; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    
    /* ===== ADMIN ALL-TEAMS VIEW ===== */
    .admin-all-teams { display: none; }
    .admin-all-teams.active { display: block; }
    
    .admin-team-row {
      margin-bottom: 1.5rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .admin-team-row-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .admin-team-row-logo {
      width: 36px;
      height: 36px;
      object-fit: contain;
    }
    
    .admin-team-row-name {
      font-weight: 700;
      font-size: 1rem;
    }
    
    .admin-team-row-abbrev {
      color: #8892b0;
      font-size: 0.8rem;
      margin-left: 0.25rem;
    }
    
    .admin-depth-chart {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.92);
      color: #1a1a2e;
    }
    
    .admin-position-column {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-height: 80px;
    }
    
    .admin-position-header {
      text-align: center;
      font-weight: 700;
      font-size: 0.85rem;
      color: #1a1a2e;
      padding: 0.3rem;
      border-bottom: 2px solid #667eea;
      margin-bottom: 0.2rem;
    }
    
    .admin-player-card {
      background: white;
      border-radius: 8px;
      padding: 0.4rem 0.5rem;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s;
      border: 2px solid transparent;
      cursor: grab;
      user-select: none;
      font-size: 0.75rem;
    }
    
    .admin-player-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: #667eea;
    }
    
    .admin-player-card.starter {
      background: linear-gradient(135deg, #fff 0%, #f0f4ff 100%);
      border: 2px solid #667eea;
    }
    
    .admin-player-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .admin-player-card.drag-over {
      border: 2px dashed #667eea;
      background: #f0f4ff;
    }
    
    .admin-position-column.drag-over {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 6px;
    }
    
    .admin-player-name {
      font-weight: 600;
      font-size: 0.75rem;
      color: #1a1a2e;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none;
    }
    
    .admin-trade-value {
      font-size: 0.65rem;
      font-weight: 600;
      pointer-events: none;
      margin-top: 1px;
    }
    
    .admin-trade-value.high { color: #16a34a; }
    .admin-trade-value.medium { color: #ca8a04; }
    .admin-trade-value.low { color: #6b7280; }
    
    @media (max-width: 900px) {
      .depth-chart { grid-template-columns: repeat(3, 1fr); }
      .admin-depth-chart { grid-template-columns: repeat(3, 1fr); }
      .team-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
    
    @media (max-width: 600px) {
      .depth-chart { grid-template-columns: repeat(2, 1fr); }
      .admin-depth-chart { grid-template-columns: repeat(2, 1fr); }
      h1 { font-size: 1.75rem; }
      .team-header-name { font-size: 1.5rem; }
      .player-image { width: 60px; height: 45px; }
    }
  </style>
</head>
<body>
  <!-- Admin banner -->
  <div id="adminBanner" class="admin-banner">
    üîß ADMIN MODE ‚Äî Drag changes are saved for all visitors
    <span id="saveStatus" class="admin-save-status">‚úì Saved</span>
  </div>

  <div class="container">
    <header>
      <h1>üèÄ NBA Depth Charts</h1>
      <p class="subtitle">Ranked by Trade Value</p>
    </header>
    
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading NBA data...</p>
    </div>
    
    <div id="teamGrid" class="team-grid" style="display: none;"></div>
    
    <!-- Single team view (public) -->
    <div id="depthChartContainer" class="depth-chart-container">
      <a href="?" class="back-btn">‚Üê All Teams</a>
      <div class="team-header">
        <img id="teamLogo" class="team-header-logo" src="" alt="">
        <h2 id="teamName" class="team-header-name"></h2>
      </div>
      <p class="drag-hint">üí° Drag players to rearrange or move between positions</p>
      <div id="depthChart" class="depth-chart"></div>
    </div>
    
    <!-- Admin all-teams view -->
    <div id="adminAllTeams" class="admin-all-teams">
      <p class="drag-hint">üí° Drag players to rearrange ‚Äî changes save automatically for all visitors</p>
      <div id="adminTeamsList"></div>
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
    
    <footer>
      Trade values computed using <a href="https://hoopsmatic.com" target="_blank">HoopsMatic</a> methodology
    </footer>
  </div>
  
  <script>
    // =====================================================
    // FIREBASE CONFIG ‚Äî Replace with your own credentials
    // =====================================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCJJU85LVzfnbvxO92JZpoVV8hpxF8sn3o",
      authDomain: "depth-charts.firebaseapp.com",
      databaseURL: "https://depth-charts-default-rtdb.firebaseio.com",
      projectId: "depth-charts",
      storageBucket: "depth-charts.firebasestorage.app",
      messagingSenderId: "153725062504",
      appId: "1:153725062504:web:0f81535fca01e943a85add"
    };
    
    // Admin password ‚Äî change this to whatever you want
    const ADMIN_KEY = "hoopsmatic2025";
    
    // =====================================================
    
    // Initialize Firebase
    let db = null;
    let isAdmin = false;
    
    function initFirebase() {
      try {
        if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
          console.warn('Firebase not configured ‚Äî using local-only mode');
          return false;
        }
        firebase.initializeApp(FIREBASE_CONFIG);
        db = firebase.database();
        return true;
      } catch (e) {
        console.error('Firebase init error:', e);
        return false;
      }
    }
    
    // Save team order to Firebase
    function saveTeamOrder(teamAbbrev, container) {
      if (!db || !isAdmin) return;
      
      const columns = container.querySelectorAll('[class*="position-column"]');
      const order = {};
      
      columns.forEach(col => {
        const pos = col.dataset.position;
        const cards = col.querySelectorAll('[class*="player-card"]');
        order[pos] = [];
        cards.forEach(card => {
          order[pos].push(card.dataset.player);
        });
      });
      
      db.ref('depthcharts/' + teamAbbrev).set(order).then(() => {
        showSaveStatus();
      }).catch(err => {
        console.error('Save error:', err);
      });
    }
    
    // Load team order from Firebase
    async function loadTeamOrder(teamAbbrev) {
      if (!db) return null;
      try {
        const snapshot = await db.ref('depthcharts/' + teamAbbrev).once('value');
        return snapshot.val();
      } catch (e) {
        console.error('Load error:', e);
        return null;
      }
    }
    
    // Flash save indicator
    function showSaveStatus() {
      const el = document.getElementById('saveStatus');
      el.classList.add('visible');
      clearTimeout(el._timeout);
      el._timeout = setTimeout(() => el.classList.remove('visible'), 2000);
    }
    
    // NBA Teams
    const NBA_TEAMS = [
      { abbrev: 'ATL', name: 'Atlanta Hawks', logo: 'https://cdn.nba.com/logos/nba/1610612737/global/L/logo.svg' },
      { abbrev: 'BOS', name: 'Boston Celtics', logo: 'https://cdn.nba.com/logos/nba/1610612738/global/L/logo.svg' },
      { abbrev: 'BKN', name: 'Brooklyn Nets', logo: 'https://cdn.nba.com/logos/nba/1610612751/global/L/logo.svg' },
      { abbrev: 'CHA', name: 'Charlotte Hornets', logo: 'https://cdn.nba.com/logos/nba/1610612766/global/L/logo.svg' },
      { abbrev: 'CHI', name: 'Chicago Bulls', logo: 'https://cdn.nba.com/logos/nba/1610612741/global/L/logo.svg' },
      { abbrev: 'CLE', name: 'Cleveland Cavaliers', logo: 'https://cdn.nba.com/logos/nba/1610612739/global/L/logo.svg' },
      { abbrev: 'DAL', name: 'Dallas Mavericks', logo: 'https://cdn.nba.com/logos/nba/1610612742/global/L/logo.svg' },
      { abbrev: 'DEN', name: 'Denver Nuggets', logo: 'https://cdn.nba.com/logos/nba/1610612743/global/L/logo.svg' },
      { abbrev: 'DET', name: 'Detroit Pistons', logo: 'https://cdn.nba.com/logos/nba/1610612765/global/L/logo.svg' },
      { abbrev: 'GSW', name: 'Golden State Warriors', logo: 'https://cdn.nba.com/logos/nba/1610612744/global/L/logo.svg' },
      { abbrev: 'HOU', name: 'Houston Rockets', logo: 'https://cdn.nba.com/logos/nba/1610612745/global/L/logo.svg' },
      { abbrev: 'IND', name: 'Indiana Pacers', logo: 'https://cdn.nba.com/logos/nba/1610612754/global/L/logo.svg' },
      { abbrev: 'LAC', name: 'LA Clippers', logo: 'https://cdn.nba.com/logos/nba/1610612746/global/L/logo.svg' },
      { abbrev: 'LAL', name: 'Los Angeles Lakers', logo: 'https://cdn.nba.com/logos/nba/1610612747/global/L/logo.svg' },
      { abbrev: 'MEM', name: 'Memphis Grizzlies', logo: 'https://cdn.nba.com/logos/nba/1610612763/global/L/logo.svg' },
      { abbrev: 'MIA', name: 'Miami Heat', logo: 'https://cdn.nba.com/logos/nba/1610612748/global/L/logo.svg' },
      { abbrev: 'MIL', name: 'Milwaukee Bucks', logo: 'https://cdn.nba.com/logos/nba/1610612749/global/L/logo.svg' },
      { abbrev: 'MIN', name: 'Minnesota Timberwolves', logo: 'https://cdn.nba.com/logos/nba/1610612750/global/L/logo.svg' },
      { abbrev: 'NOP', name: 'New Orleans Pelicans', logo: 'https://cdn.nba.com/logos/nba/1610612740/global/L/logo.svg' },
      { abbrev: 'NYK', name: 'New York Knicks', logo: 'https://cdn.nba.com/logos/nba/1610612752/global/L/logo.svg' },
      { abbrev: 'OKC', name: 'Oklahoma City Thunder', logo: 'https://cdn.nba.com/logos/nba/1610612760/global/L/logo.svg' },
      { abbrev: 'ORL', name: 'Orlando Magic', logo: 'https://cdn.nba.com/logos/nba/1610612753/global/L/logo.svg' },
      { abbrev: 'PHI', name: 'Philadelphia 76ers', logo: 'https://cdn.nba.com/logos/nba/1610612755/global/L/logo.svg' },
      { abbrev: 'PHX', name: 'Phoenix Suns', logo: 'https://cdn.nba.com/logos/nba/1610612756/global/L/logo.svg' },
      { abbrev: 'POR', name: 'Portland Trail Blazers', logo: 'https://cdn.nba.com/logos/nba/1610612757/global/L/logo.svg' },
      { abbrev: 'SAC', name: 'Sacramento Kings', logo: 'https://cdn.nba.com/logos/nba/1610612758/global/L/logo.svg' },
      { abbrev: 'SAS', name: 'San Antonio Spurs', logo: 'https://cdn.nba.com/logos/nba/1610612759/global/L/logo.svg' },
      { abbrev: 'TOR', name: 'Toronto Raptors', logo: 'https://cdn.nba.com/logos/nba/1610612761/global/L/logo.svg' },
      { abbrev: 'UTA', name: 'Utah Jazz', logo: 'https://cdn.nba.com/logos/nba/1610612762/global/L/logo.svg' },
      { abbrev: 'WAS', name: 'Washington Wizards', logo: 'https://cdn.nba.com/logos/nba/1610612764/global/L/logo.svg' }
    ];
    
    // Team name mapping
    const TEAM_ALIASES = {
      'Atlanta': 'ATL', 'Hawks': 'ATL',
      'Boston': 'BOS', 'Celtics': 'BOS',
      'Brooklyn': 'BKN', 'Nets': 'BKN',
      'Charlotte': 'CHA', 'Hornets': 'CHA',
      'Chicago': 'CHI', 'Bulls': 'CHI',
      'Cleveland': 'CLE', 'Cavaliers': 'CLE', 'Cavs': 'CLE',
      'Dallas': 'DAL', 'Mavericks': 'DAL', 'Mavs': 'DAL',
      'Denver': 'DEN', 'Nuggets': 'DEN',
      'Detroit': 'DET', 'Pistons': 'DET',
      'Golden State': 'GSW', 'Warriors': 'GSW',
      'Houston': 'HOU', 'Rockets': 'HOU',
      'Indiana': 'IND', 'Pacers': 'IND',
      'LA Clippers': 'LAC', 'Clippers': 'LAC',
      'Los Angeles Lakers': 'LAL', 'Lakers': 'LAL', 'LA Lakers': 'LAL',
      'Memphis': 'MEM', 'Grizzlies': 'MEM',
      'Miami': 'MIA', 'Heat': 'MIA',
      'Milwaukee': 'MIL', 'Bucks': 'MIL',
      'Minnesota': 'MIN', 'Timberwolves': 'MIN', 'Wolves': 'MIN',
      'New Orleans': 'NOP', 'Pelicans': 'NOP',
      'New York': 'NYK', 'Knicks': 'NYK',
      'Oklahoma City': 'OKC', 'Thunder': 'OKC',
      'Orlando': 'ORL', 'Magic': 'ORL',
      'Philadelphia': 'PHI', '76ers': 'PHI', 'Sixers': 'PHI',
      'Phoenix': 'PHX', 'Suns': 'PHX',
      'Portland': 'POR', 'Trail Blazers': 'POR', 'Blazers': 'POR',
      'Sacramento': 'SAC', 'Kings': 'SAC',
      'San Antonio': 'SAS', 'Spurs': 'SAS',
      'Toronto': 'TOR', 'Raptors': 'TOR',
      'Utah': 'UTA', 'Jazz': 'UTA',
      'Washington': 'WAS', 'Wizards': 'WAS'
    };
    
    // Data URLs
    const TV_SHEET_ID = '2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7';
    const TV_GID = '1310971167';
    const TV_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${TV_SHEET_ID}/pub?gid=${TV_GID}&single=true&output=csv`;
    
    const ROSTER_GID = '0';
    const ROSTER_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${TV_SHEET_ID}/pub?gid=${ROSTER_GID}&single=true&output=csv`;
    
    let allPlayers = [];
    let tradeValueMap = new Map();
    let draggedElement = null;
    
    // CSV Parser
    function parseCSV(text) {
      const rows = []; let current = '', inQuotes = false, row = [];
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"' && text[i+1] === '"') { current += '"'; i++; }
          else if (ch === '"') inQuotes = false;
          else current += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { row.push(current.trim()); current = ''; }
          else if (ch === '\n' || ch === '\r') {
            if (ch === '\r' && text[i+1] === '\n') i++;
            row.push(current.trim());
            if (row.length > 1 || row[0] !== '') rows.push(row);
            row = []; current = '';
          } else current += ch;
        }
      }
      if (current || row.length > 0) { row.push(current.trim()); if (row.length > 1 || row[0] !== '') rows.push(row); }
      return rows;
    }
    
    // Trade value computation
    function computeTradeValues(csvText) {
      const rows = parseCSV(csvText);
      const roster = [], historical = [];
      let todayStr = null;
      
      for (const row of rows.slice(1)) {
        while (row.length < 22) row.push('');
        if (row[18] && !todayStr) todayStr = row[18];
        if (row[0] && row[1]) {
          roster.push({
            player: row[1].trim(),
            rat365: parseFloat(row[2]) || 0,
            salary: parseInt(row[3].replace(/[$,]/g, '')) || 0,
            birthday: row[4] || '',
            draftPick: parseInt(row[20]) || null
          });
        }
        if (row[6] && row[7]) {
          const g = parseInt(row[9]) || 0;
          if (g > 0) historical.push({
            year: row[6], player: row[7].trim(),
            totalRat: parseFloat(row[8].replace(/,/g, '')) || 0, games: g
          });
        }
      }
      
      const playerHist = {};
      for (const h of historical) {
        const k = h.player.toLowerCase();
        if (!playerHist[k]) playerHist[k] = [];
        playerHist[k].push(h);
      }
      
      const WEIGHTS = {'2025-26':1.0,'2024-25':0.6,'2023-24':0.36,'2022-23':0.216,'2021-22':0.1296};
      const EXPECTED = {'2021-22':82,'2022-23':82,'2023-24':82,'2024-25':82,'2025-26':48};
      const EXP = 1.8, BETA = 0.8, MAX_MULT = 1.4, MIN_PCT = 0.40;
      const WM_W = 0.85, RAT_W = 0.15, AGE_BONUS = 1.0, OLD_TH = 35, OLD_PEN = 0.03;
      
      for (const p of roster) {
        const hist = playerHist[p.player.toLowerCase()] || [];
        let num = 0, den = 0;
        for (const h of hist) {
          const w = WEIGHTS[h.year] || 0;
          if (w <= 0 || h.games <= 0) continue;
          let perGame = h.totalRat / h.games;
          const exp = EXPECTED[h.year] || 82;
          if (h.games / exp >= MIN_PCT) perGame *= Math.min(MAX_MULT, Math.pow(exp / h.games, BETA));
          num += perGame * w * h.games;
          den += w * h.games;
        }
        p.watermark = den > 0 ? num / den : 0;
        
        const cur = hist.filter(h => h.year === '2025-26');
        const curGames = cur.reduce((s,h) => s + h.games, 0);
        p.rat365adj = (curGames > 0 && curGames / 48 >= MIN_PCT) 
          ? p.rat365 * Math.min(MAX_MULT, Math.pow(48 / curGames, BETA)) 
          : p.rat365;
      }
      
      const parseDate = s => {
        if (!s) return null;
        const parts = s.split('/');
        return parts.length === 3 ? new Date(+parts[2], +parts[0]-1, +parts[1]) : null;
      };
      const today = parseDate(todayStr) || new Date();
      const ages = [];
      for (const p of roster) {
        const bd = parseDate(p.birthday);
        p.age = bd ? (today - bd) / (365.25 * 24 * 60 * 60 * 1000) : null;
        if (p.age) ages.push(p.age);
      }
      const avgAge = ages.length > 0 ? ages.reduce((a,b) => a+b, 0) / ages.length : 26;
      const maxDev = avgAge - Math.min(...ages);
      
      for (const p of roster) {
        if (p.age !== null && p.age < avgAge) p.ageMult = 1.0 + AGE_BONUS * (avgAge - p.age) / maxDev;
        else if (p.age !== null && p.age >= OLD_TH) p.ageMult = Math.max(0.5, 1.0 - OLD_PEN * (p.age - OLD_TH));
        else p.ageMult = 1.0;
      }
      
      const totalSalPool = roster.reduce((s,p) => s + p.salary, 0);
      const totalWM = roster.reduce((s,p) => s + Math.pow(Math.max(p.watermark,0), EXP), 0);
      const totalRAT = roster.reduce((s,p) => s + Math.pow(Math.max(p.rat365adj,0), EXP), 0);
      
      for (const p of roster) {
        const tvWM = totalWM > 0 ? (Math.pow(Math.max(p.watermark,0), EXP) / totalWM) * totalSalPool : 0;
        const tvRAT = totalRAT > 0 ? (Math.pow(Math.max(p.rat365adj,0), EXP) / totalRAT) * totalSalPool : 0;
        p.tvWithAge = (WM_W * tvWM + RAT_W * tvRAT) * p.ageMult;
      }
      
      const totalWithAge = roster.reduce((s,p) => s + p.tvWithAge, 0);
      
      const result = new Map();
      for (const p of roster) {
        const baseTV = totalWithAge > 0 ? Math.round((p.tvWithAge / totalWithAge) * totalSalPool) : 0;
        let potentialBonus = 0;
        if (p.age !== null && p.age < 25 && p.draftPick && p.draftPick >= 1 && p.draftPick <= 60) {
          const draftFactor = Math.exp(-0.05 * (p.draftPick - 1));
          const ageFactor = Math.exp(-0.5 * Math.max(0, p.age - 18.82));
          potentialBonus = Math.round(7000000 * draftFactor * ageFactor);
        }
        result.set(p.player.toLowerCase(), baseTV + potentialBonus);
      }
      return result;
    }
    
    // Parse roster
    function parseRosterCSV(csvText) {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return [];
      
      const header = rows[0];
      const colIndex = name => header.findIndex(h => h.toUpperCase() === name.toUpperCase());
      
      const playerIdx = colIndex('PLAYER');
      const teamIdx = colIndex('TEAM');
      const posIdx = colIndex('POSITION');
      const headshotIdx = colIndex('HEADSHOT');
      
      if (playerIdx < 0 || teamIdx < 0) return [];
      
      const players = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const name = row[playerIdx]?.trim();
        const team = row[teamIdx]?.trim();
        
        if (!name || !team) continue;
        
        const teamAbbrev = TEAM_ALIASES[team] || team;
        const position = row[posIdx]?.trim() || 'SF';
        const headshot = row[headshotIdx]?.trim() || '';
        const tv = tradeValueMap.get(name.toLowerCase()) || 0;
        
        players.push({ name, team: teamAbbrev, position, tradeValue: tv, headshot });
      }
      return players;
    }
    
    // Utility functions
    function formatTradeValue(tv) {
      if (tv >= 1000000) return '$' + (tv / 1000000).toFixed(1) + 'M';
      if (tv >= 1000) return '$' + (tv / 1000).toFixed(0) + 'K';
      return '$' + tv.toLocaleString();
    }
    
    function getValueClass(tv) {
      if (tv >= 20000000) return 'high';
      if (tv >= 5000000) return 'medium';
      return 'low';
    }
    
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('');
    }
    
    // Render team grid (public landing)
    function renderTeamGrid() {
      const grid = document.getElementById('teamGrid');
      grid.innerHTML = NBA_TEAMS.map(team => `
        <a href="?team=${team.abbrev}" class="team-card">
          <img class="team-logo" src="${team.logo}" alt="${team.name}" onerror="this.style.opacity='0.3'">
          <div class="team-name">${team.name}</div>
          <div class="team-abbrev">${team.abbrev}</div>
        </a>
      `).join('');
      grid.style.display = 'grid';
    }
    
    // =====================================================
    // SINGLE TEAM VIEW (public, with Firebase defaults)
    // =====================================================
    async function renderDepthChart(teamAbbrev) {
      const team = NBA_TEAMS.find(t => t.abbrev === teamAbbrev);
      if (!team) {
        document.getElementById('error').textContent = `Team "${teamAbbrev}" not found`;
        document.getElementById('error').style.display = 'block';
        return;
      }
      
      const teamPlayers = allPlayers.filter(p => p.team === teamAbbrev);
      
      if (teamPlayers.length === 0) {
        document.getElementById('error').textContent = `No players found for ${team.name}`;
        document.getElementById('error').style.display = 'block';
        return;
      }
      
      document.getElementById('teamLogo').src = team.logo;
      document.getElementById('teamName').textContent = team.name;
      document.title = `${team.name} Depth Chart`;
      
      const positions = ['PG', 'SG', 'SF', 'PF', 'C'];
      
      // Try loading saved order from Firebase
      const savedOrder = await loadTeamOrder(teamAbbrev);
      
      let byPosition = {};
      positions.forEach(pos => byPosition[pos] = []);
      
      if (savedOrder) {
        // Use saved order from Firebase
        const playerMap = {};
        teamPlayers.forEach(p => playerMap[p.name] = p);
        const placed = new Set();
        
        positions.forEach(pos => {
          if (savedOrder[pos]) {
            savedOrder[pos].forEach(playerName => {
              if (playerMap[playerName] && !placed.has(playerName)) {
                byPosition[pos].push(playerMap[playerName]);
                placed.add(playerName);
              }
            });
          }
        });
        
        // Add any new players not in saved order (fallback by TV)
        teamPlayers.forEach(p => {
          if (!placed.has(p.name)) {
            const pos = positions.includes(p.position) ? p.position : 'SF';
            byPosition[pos].push(p);
          }
        });
      } else {
        // Fallback: sort by trade value
        teamPlayers.forEach(player => {
          const pos = positions.includes(player.position) ? player.position : 'SF';
          byPosition[pos].push(player);
        });
        positions.forEach(pos => byPosition[pos].sort((a, b) => b.tradeValue - a.tradeValue));
      }
      
      let html = '';
      positions.forEach(pos => {
        html += `<div class="position-column" data-position="${pos}">
          <div class="position-header">${pos}</div>`;
        
        byPosition[pos].forEach((player, idx) => {
          const tvFormatted = formatTradeValue(player.tradeValue);
          const valueClass = getValueClass(player.tradeValue);
          const isStarter = idx === 0 ? 'starter' : '';
          
          html += `
            <div class="player-card ${isStarter}" draggable="true" data-player="${player.name}" data-tv="${player.tradeValue}">
              <div class="player-image">
                ${player.headshot 
                  ? `<img src="${player.headshot}" alt="${player.name}" onerror="this.parentElement.innerHTML='<span class=\\'initials\\'>${getInitials(player.name)}</span>'">`
                  : `<span class="initials">${getInitials(player.name)}</span>`
                }
              </div>
              <div class="player-name">${player.name}</div>
              <div class="trade-value ${valueClass}">${tvFormatted}</div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      document.getElementById('depthChart').innerHTML = html;
      document.getElementById('depthChartContainer').classList.add('active');
      
      setupDragAndDrop(document.getElementById('depthChart'), teamAbbrev);
    }
    
    // =====================================================
    // ADMIN ALL-TEAMS VIEW
    // =====================================================
    async function renderAdminAllTeams() {
      document.getElementById('adminBanner').classList.add('active');
      document.title = 'NBA Depth Charts ‚Äî ADMIN';
      
      const container = document.getElementById('adminTeamsList');
      let html = '';
      
      // Pre-load all saved orders
      const savedOrders = {};
      if (db) {
        try {
          const snapshot = await db.ref('depthcharts').once('value');
          const allSaved = snapshot.val();
          if (allSaved) Object.assign(savedOrders, allSaved);
        } catch (e) {
          console.error('Failed to load all orders:', e);
        }
      }
      
      const positions = ['PG', 'SG', 'SF', 'PF', 'C'];
      
      for (const team of NBA_TEAMS) {
        const teamPlayers = allPlayers.filter(p => p.team === team.abbrev);
        if (teamPlayers.length === 0) continue;
        
        const savedOrder = savedOrders[team.abbrev] || null;
        let byPosition = {};
        positions.forEach(pos => byPosition[pos] = []);
        
        if (savedOrder) {
          const playerMap = {};
          teamPlayers.forEach(p => playerMap[p.name] = p);
          const placed = new Set();
          
          positions.forEach(pos => {
            if (savedOrder[pos]) {
              savedOrder[pos].forEach(playerName => {
                if (playerMap[playerName] && !placed.has(playerName)) {
                  byPosition[pos].push(playerMap[playerName]);
                  placed.add(playerName);
                }
              });
            }
          });
          
          teamPlayers.forEach(p => {
            if (!placed.has(p.name)) {
              const pos = positions.includes(p.position) ? p.position : 'SF';
              byPosition[pos].push(p);
            }
          });
        } else {
          teamPlayers.forEach(player => {
            const pos = positions.includes(player.position) ? player.position : 'SF';
            byPosition[pos].push(player);
          });
          positions.forEach(pos => byPosition[pos].sort((a, b) => b.tradeValue - a.tradeValue));
        }
        
        html += `
          <div class="admin-team-row" data-team="${team.abbrev}">
            <div class="admin-team-row-header">
              <img class="admin-team-row-logo" src="${team.logo}" alt="${team.name}" onerror="this.style.opacity='0.3'">
              <span class="admin-team-row-name">${team.name}</span>
              <span class="admin-team-row-abbrev">${team.abbrev}</span>
            </div>
            <div class="admin-depth-chart" data-team="${team.abbrev}">`;
        
        positions.forEach(pos => {
          html += `<div class="admin-position-column" data-position="${pos}">
            <div class="admin-position-header">${pos}</div>`;
          
          byPosition[pos].forEach((player, idx) => {
            const tvFormatted = formatTradeValue(player.tradeValue);
            const valueClass = getValueClass(player.tradeValue);
            const isStarter = idx === 0 ? 'starter' : '';
            
            html += `
              <div class="admin-player-card ${isStarter}" draggable="true" data-player="${player.name}" data-tv="${player.tradeValue}">
                <div class="admin-player-name">${player.name}</div>
                <div class="admin-trade-value ${valueClass}">${tvFormatted}</div>
              </div>`;
          });
          
          html += '</div>';
        });
        
        html += `</div></div>`;
      }
      
      container.innerHTML = html;
      document.getElementById('adminAllTeams').classList.add('active');
      
      // Setup drag-drop for each team's chart
      document.querySelectorAll('.admin-depth-chart').forEach(chart => {
        const teamAbbrev = chart.dataset.team;
        setupAdminDragAndDrop(chart, teamAbbrev);
      });
    }
    
    // =====================================================
    // DRAG AND DROP ‚Äî Public single-team view
    // =====================================================
    function setupDragAndDrop(container, teamAbbrev) {
      const cards = container.querySelectorAll('.player-card');
      const columns = container.querySelectorAll('.position-column');
      
      cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', function(e) {
          handleDragEnd.call(this, e);
          if (isAdmin) saveTeamOrder(teamAbbrev, container);
        });
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragleave', handleDragLeave);
      });
      
      columns.forEach(col => {
        col.addEventListener('dragover', handleColumnDragOver);
        col.addEventListener('drop', function(e) {
          handleColumnDrop.call(this, e);
          if (isAdmin) saveTeamOrder(teamAbbrev, container);
        });
        col.addEventListener('dragleave', handleColumnDragLeave);
      });
    }
    
    // =====================================================
    // DRAG AND DROP ‚Äî Admin all-teams view
    // =====================================================
    function setupAdminDragAndDrop(chart, teamAbbrev) {
      const cards = chart.querySelectorAll('.admin-player-card');
      const columns = chart.querySelectorAll('.admin-position-column');
      
      cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', function(e) {
          handleDragEnd.call(this, e);
          saveTeamOrder(teamAbbrev, chart);
          updateAdminStarterHighlights(chart);
        });
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragleave', handleDragLeave);
      });
      
      columns.forEach(col => {
        col.addEventListener('dragover', handleColumnDragOver);
        col.addEventListener('drop', function(e) {
          handleColumnDrop.call(this, e);
          saveTeamOrder(teamAbbrev, chart);
          updateAdminStarterHighlights(chart);
        });
        col.addEventListener('dragleave', handleColumnDragLeave);
      });
    }
    
    // Shared drag handlers
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.player);
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      draggedElement = null;
      updateStarterHighlights();
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      if (this !== draggedElement) {
        this.classList.add('drag-over');
      }
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('drag-over');
      
      if (this !== draggedElement && draggedElement) {
        const targetColumn = this.parentElement;
        const targetRect = this.getBoundingClientRect();
        const insertBefore = e.clientY < targetRect.top + targetRect.height / 2;
        
        if (insertBefore) {
          targetColumn.insertBefore(draggedElement, this);
        } else {
          targetColumn.insertBefore(draggedElement, this.nextSibling);
        }
      }
    }
    
    function handleColumnDragOver(e) {
      e.preventDefault();
      if (e.target.classList.contains('admin-position-column') || e.target.classList.contains('admin-position-header') ||
          e.target.classList.contains('position-column') || e.target.classList.contains('position-header')) {
        this.classList.add('drag-over');
      }
    }
    
    function handleColumnDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function handleColumnDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      if (draggedElement && !e.target.classList.contains('player-card') && !e.target.classList.contains('admin-player-card')) {
        this.appendChild(draggedElement);
      }
    }
    
    function updateStarterHighlights() {
      document.querySelectorAll('.position-column').forEach(col => {
        const cards = col.querySelectorAll('.player-card');
        cards.forEach((card, idx) => {
          card.classList.toggle('starter', idx === 0);
        });
      });
    }
    
    function updateAdminStarterHighlights(chart) {
      chart.querySelectorAll('.admin-position-column').forEach(col => {
        const cards = col.querySelectorAll('.admin-player-card');
        cards.forEach((card, idx) => {
          card.classList.toggle('starter', idx === 0);
        });
      });
    }
    
    // =====================================================
    // INIT
    // =====================================================
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const teamParam = params.get('team')?.toUpperCase();
      const adminParam = params.get('admin');
      
      // Check admin mode
      isAdmin = (adminParam === ADMIN_KEY);
      
      // Init Firebase
      initFirebase();
      
      try {
        const [tvResponse, rosterResponse] = await Promise.all([
          fetch(TV_CSV_URL),
          fetch(ROSTER_CSV_URL)
        ]);
        
        if (!tvResponse.ok || !rosterResponse.ok) throw new Error('Failed to fetch data');
        
        const [tvText, rosterText] = await Promise.all([
          tvResponse.text(),
          rosterResponse.text()
        ]);
        
        tradeValueMap = computeTradeValues(tvText);
        allPlayers = parseRosterCSV(rosterText);
        
        document.getElementById('loading').style.display = 'none';
        
        if (isAdmin && !teamParam) {
          // Admin mode: show all teams
          await renderAdminAllTeams();
        } else if (teamParam && NBA_TEAMS.some(t => t.abbrev === teamParam)) {
          await renderDepthChart(teamParam);
        } else {
          renderTeamGrid();
        }
        
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = 'Error loading data. Please refresh.';
        document.getElementById('error').style.display = 'block';
      }
    }
    
    init();
  </script>
</body>
</html>
